name: Build LineageOS Miatoll (Optimized)

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'URL манифеста'
        required: true
        default: 'https://github.com/LineageOS/android.git'
      MANIFEST_BRANCH:
        description: 'Ветка'
        required: true
        default: 'lineage-20.0'
      BUILD_TARGET:
        description: 'Цель (bacon - прошивка, recoveryimage - только рекавери)'
        required: true
        default: 'recoveryimage' # По умолчанию ставим рекавери, чтобы точно влезло по месту

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: Checkout Workflow
      uses: actions/checkout@v4

    - name: Maximize Build Space
      run: |
        echo "Before cleanup:"
        df -h
        # Удаление огромных предустановленных инструментов
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc /usr/local/share/powershell /usr/share/swift /usr/local/.ghcup /var/lib/mongodb /usr/local/lib/node_modules /opt/hostedtoolcache
        sudo docker image prune -a -f
        sudo apt-get clean
        # Удаление лишних пакетов
        sudo apt-get purge -y google-cloud-sdk azure-cli microsoft-edge-dev firefox mono-devel
        sudo apt-get autoremove -y
        echo "After cleanup:"
        df -h

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y bc bison build-essential ccache curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python3
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH
        git config --global user.name "MiatollBuilder"
        git config --global user.email "bot@github.com"

    - name: Repo Init
      run: |
        mkdir work
        cd work
        repo init -u ${{ github.event.inputs.MANIFEST_URL }} -b ${{ github.event.inputs.MANIFEST_BRANCH }} --depth=1
        
        mkdir -p .repo/local_manifests
        echo '<?xml version="1.0" encoding="UTF-8"?>
        <manifest>
            <project path="device/xiaomi/miatoll" name="https://github.com/LineageOS/android_device_xiaomi_miatoll" remote="github" revision="lineage-20" />
            <project path="kernel/xiaomi/sm6250" name="https://github.com/LineageOS/android_kernel_xiaomi_sm6250" remote="github" revision="lineage-20" />
            <project path="vendor/xiaomi/miatoll" name="https://github.com/LineageOS/android_vendor_xiaomi_miatoll" remote="github" revision="lineage-20" />
            <project path="hardware/xiaomi" name="https://github.com/LineageOS/android_hardware_xiaomi" remote="github" revision="lineage-20" />
        </manifest>' > .repo/local_manifests/miatoll.xml

    - name: Repo Sync
      run: |
        cd work
        # Исправлено: убран --depth, добавлен --no-tags для экономии места
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: Build ROM
      run: |
        cd work
        source build/envsetup.sh
        # Отключаем ccache, так как он забивает место на диске при первой сборке
        export USE_CCACHE=0
        lunch lineage_miatoll-userdebug
        mka ${{ github.event.inputs.BUILD_TARGET }}

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4 # Обновлено до v4
      if: success()
      with:
        name: Miatoll-Output
        path: |
          work/out/target/product/miatoll/*.zip
          work/out/target/product/miatoll/*.img
